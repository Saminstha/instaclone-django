{% extends "base.html" %}
{% block content %}

<div class="container mt-4">

  <!-- ================= PROFILE HEADER ================= -->
  <div class="row align-items-center">

    <!-- Profile Picture -->
    <div class="col-md-3 text-center mb-3 mb-md-0">
      <img src="{{ profile.profile_picture.url }}"
           class="rounded-circle"
           width="120" height="120"
           style="object-fit: cover;">
    </div>

    <!-- User Info -->
    <div class="col-md-9">

      <h3>{{ profile.user.username }}</h3>

      <!-- Stats -->
      <div class="d-flex gap-4 my-2">
        <span><strong>{{ posts_count }}</strong> posts</span>
        <span><strong id="followers-count">{{ followers_count }}</strong> followers</span>
        <span><strong>{{ following_count }}</strong> following</span>
      </div>

      <p class="fw-bold mb-1">{{ profile.full_name }}</p>
      <p class="text-muted">{{ profile.bio }}</p>

      <!-- Follow Button -->
      {% if user.is_authenticated and user != profile.user %}
        <button
            id="follow-btn"
            class="btn btn-sm {% if profile in user.profile.following.all %}btn-outline-secondary{% else %}btn-primary{% endif %}"
            data-username="{{ profile.user.username }}"
        >
            {% if profile in user.profile.following.all %}
                Unfollow
            {% else %}
                Follow
            {% endif %}
        </button>
      {% endif %}

    </div>
  </div>

  <hr>

  <!-- ================= POSTS GRID (NEWEST FIRST) ================= -->
  <div class="row g-1">

    {% for post in posts %}
      <div class="col-4">
        <a href="{% url 'post_detail' post.id %}">
          <div style="
              position: relative;
              width: 100%;
              padding-top: 100%;
              overflow: hidden;
          ">
            <img src="{{ post.image.url }}"
                 style="
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    object-fit: cover;
                 ">
          </div>
        </a>
      </div>
    {% empty %}
      <div class="col-12 text-center mt-4">
        <p class="text-muted">No posts yet.</p>
      </div>
    {% endfor %}

  </div>
</div>


<!-- ================= FOLLOW AJAX ================= -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    const btn = document.getElementById('follow-btn');
    if (!btn) return;

    btn.addEventListener('click', function () {
        const username = btn.dataset.username;

        fetch(`/u/${username}/follow/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
            },
        })
        .then(response => response.json())
        .then(data => {
            const followersCount = document.getElementById('followers-count');

            if (data.followed) {
                btn.textContent = 'Unfollow';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline-secondary');
            } else {
                btn.textContent = 'Follow';
                btn.classList.remove('btn-outline-secondary');
                btn.classList.add('btn-primary');
            }

            followersCount.textContent = data.followers_count;
        });
    });
});
</script>

{% endblock %}