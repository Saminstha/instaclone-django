{% extends "base.html" %}
{% block content %}

<div class="container mt-4" style="max-width: 600px;">

    {% for post in posts %}
    <div class="card mb-4">

        <!--  Post Header -->
        <div class="card-header bg-white d-flex align-items-center">
            <img src="{{ post.user.profile.profile_picture.url }}"
                 class="rounded-circle me-2"
                 width="40" height="40">

            <a href="{% url 'user_profile' post.user.username %}"
               class="fw-bold text-dark text-decoration-none">
                {{ post.user.username }}
            </a>
        </div>

        <!--  Post Image -->
        <img src="{{ post.image.url }}" class="card-img-top">

        <!--  Like + Likes Count -->
        <div class="px-3 pt-2">
            <div class="d-flex align-items-center">

                <button
                    class="btn p-0 me-2 like-btn"
                    data-post-id="{{ post.id }}"
                    style="font-size: 22px;"
                >
                    {% if user in post.likes.all %}
                        ‚ù§Ô∏è
                    {% else %}
                        ü§ç
                    {% endif %}
                </button>

                <span>
                    <strong class="likes-count">
                        {{ post.likes.count }}
                    </strong> likes
                </span>

            </div>
        </div>

        <!--  Caption -->
        <div class="px-3 pt-1">
            <p class="mb-1">
                <strong>{{ post.user.username }}</strong>
                {{ post.caption }}
            </p>
        </div>

        <!--  Comments Section -->
        <div class="px-3 pb-2">

            {% if post.comments.count > 2 %}
                <a href="{% url 'post_detail' post.id %}"
                class="text-muted text-decoration-none d-block mb-1"
                style="font-size: 14px;">
                    View all {{ post.comments.count }} comments
                </a>
            {% endif %}

            {% for comment in post.comments.all|slice:":2" %}
                <div class="small text-break">
                    <strong>{{ comment.user.username }}</strong>
                    {{ comment.text }}
                </div>
            {% endfor %}

        </div>
        
        <!--  Add Comment -->
        <form action="{% url 'add_comment' post.id %}"
              method="POST"
              class="d-flex border-top p-2">
            {% csrf_token %}
            <input type="text"
                   name="text"
                   class="form-control border-0"
                   placeholder="Add a comment..."
                   required>
            <button type="submit"
                    class="btn btn-link text-primary">
                Post
            </button>
        </form>

        <!--  Timestamp -->
        <div class="px-3 pb-2">
            <small class="text-muted">
                {{ post.created_at|timesince }} ago
            </small>
        </div>

    </div>
    {% endfor %}

</div>
<script>
document.addEventListener('DOMContentLoaded', function () {

    const likeButtons = document.querySelectorAll('.like-btn');

    likeButtons.forEach(button => {
        button.addEventListener('click', function () {

            const postId = this.dataset.postId;

            fetch(`/post/${postId}/like/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {

                const likesCount = this.closest('.d-flex')
                    .querySelector('.likes-count');

                likesCount.textContent = data.likes_count;

                if (data.liked) {
                    this.textContent = '‚ù§Ô∏è';
                } else {
                    this.textContent = 'ü§ç';
                }
            });

        });
    });

});

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

{% endblock %}